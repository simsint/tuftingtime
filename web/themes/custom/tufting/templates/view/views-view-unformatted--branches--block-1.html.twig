{% if title %}
  <h3>{{ title }}</h3>
{% endif %}

{% for row in view.result %}
  {%
    set row_classes = [
      'views-row',
    ]
  %}

  {% set plan = row._entity %}
  {% set index = loop.index0 %}


{# ------------------------------------------------------------- #}
{# --- Corrected steps for Media Entity Reference field: ----- #}

{# 1. Get the referenced Media Entity (e.g., Media Type: Image). #}
{% set media_entity = plan.field_gallery_image.entity %}

{% set image_url = null %}

	{% if media_entity %}
	{# 2. Get the actual file field within the Media Entity. #}
	{# This field is typically named 'field_media_image' for Drupal's standard Image Media Type. #}
	{% set file_field = media_entity.field_media_image.entity %}

	{# 3. Get the file URI from the File Entity. #}
		{% if file_field %}
		{% set image_uri = file_field.uri.value %}

		{# 4. Generate the absolute URL. #}
	{% set image_url = image_uri | image_style('branch_card') %}
{% endif %}
{% endif %}
{# ------------------------------------------------------------- #}

{% set video_url = null %}
{% set video_file_entity = plan.field_video_file.entity %}

{% if video_file_entity %}
	{# 1. Get the File URI (e.g., 'public://videos/file.mp4') #}
	{% set video_uri = video_file_entity.uri.value %}

	{# 2. Convert the URI to a web-accessible URL using file_url() #}
	{% set video_url = video_uri | file_url %}
{% endif %}

{% set autoplay_raw_value = plan.field_autoplay_video.value %}
{% set autoplay_attribute = '' %}
{% if autoplay_raw_value == 1 %}
    {% set autoplay_attribute = 'autoplay ' %}
{% endif %}

{% set loop_raw_value = plan.field_loop_video.value %}
{% set loop_attribute = '' %}
{% if loop_raw_value == 1 %}
	{% set loop_attribute = 'loop ' %}
{% endif %}


{% set mute_raw_value = plan.field_mute_video.value %}
{% set mute_attribute = '' %}
{% if mute_raw_value == 1 %}
	{% set mute_attribute = 'muted ' %}
{% endif %}




<section class="section section--illustration section--sohowroom">
	<div class="illustration showroom">
		<div
			class="illustration__bg-wrapper">
			<!--<img src="{{image_url}}" loading="lazy" alt="{{ media_entity.label }}" class=""/>-->
			{% if video_url is not empty %}
				<video class=" branch-banner-video-wrapper" style="--bs-aspect-ratio: 56.25%;" controls="false" {{ autoplay_attribute }} {{ mute_attribute }} {{ loop_attribute }} playsinline>
					<source src="{{ video_url }}" type="">
					Your browser does not support the video tag.
				</video>
			{% else %}
					<img src="{{image_url}}" loading="lazy" alt="{{ media_entity.label }}" class=""/>
			{% endif %}
		</div>
		<div class="illustration__inner">
			<div class="illustration__body illustration__body--no-bottom-padding">
				<div class="illustration__content">
					<div class="illustration__heading italic">{{ plan.title.value }}</div>
					<p class="illustration__address">
					{{ plan.field_address.value }}
					</p>
					<div class="illustration__details">
					{% if plan.field_map_url.value %}

							<p>
                <strong>Map:</strong>

								<span class="links">
									<a href="{{plan.field_map_url.value}}" target="_blank" class="gmap_text">
											<span>Click for Direction</span>
											<img src="/themes/custom/tufting/images/google-maps.png" loading="lazy" alt="Google Maps" class="gmap__image">
									</a>
								</span>
              </p>

					{% endif %}

						{% if plan.field_phone is not empty %}
                <p>
                  <strong>Phone:</strong>
                  <span class="links">
                    {% for item in plan.field_phone %}
                      <a href="tel:{{ item.value | replace({' ': '', '(': '', ')': '', '-': ''}) }}">{{ item.value }}</a>
                    {% endfor %}
                  </span>
                </p>
                {% endif %}
						{% if plan.field_email is not empty %}
                <p>
                  <strong>Email:</strong>
                  <span class="links">
                    {% for item in plan.field_email %}
                      <a href="mailto:{{ item.value }}">{{ item.value }}</a>
                    {% endfor %}
                  </span>
                </p>
                {% endif %}
					</div>
					{% if plan.field_whatsapp_link.value %}
					<a href="{{ plan.field_whatsapp_link.value }}" class="whatsapp-link" target="_blank">Chat on WhatsApp</a>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
</section>

{% endfor %}

